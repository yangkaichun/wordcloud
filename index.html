
 <!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>國衛院AI管家_問答文字雲生成器</title>
    <script src="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #0072CE;
            --secondary-color: #00A650;
            --accent-color: #00B8D4;
            --light-bg: #f5f7fa;
            --lighter-bg: #ffffff;
        }
        
        body {
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--light-bg);
            color: #333;
            transition: background-color 0.3s ease;
            overflow-x: hidden;
        }
        
        .tech-card {
            background-color: var(--lighter-bg);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 114, 206, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .tech-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--accent-color));
        }
        
        .tech-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 114, 206, 0.2);
        }
        
        .tech-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 114, 206, 0.3);
        }
        
        .tech-btn:active {
            transform: translateY(0);
        }
        
        .tech-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transform: translateX(-100%);
        }
        
        .tech-btn:hover::after {
            animation: shimmer 1.5s infinite;
        }
        
        .file-btn {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(75, 85, 99, 0.2);
        }
        
        .file-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(75, 85, 99, 0.3);
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 114, 206, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        .word-cloud-container {
            position: relative;
            width: 100%;
            height: calc(90vh - 200px);
            min-height: 400px;
            margin-top: 20px;
            border-radius: 50% / 50%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(245, 247, 250, 0.9));
            box-shadow: 0 10px 30px rgba(0, 114, 206, 0.15);
            overflow: hidden;
        }
        
        .circuit-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 114, 206, 0.03) 0%, transparent 20%),
                radial-gradient(circle at 90% 30%, rgba(0, 166, 80, 0.03) 0%, transparent 20%),
                radial-gradient(circle at 50% 80%, rgba(0, 184, 212, 0.03) 0%, transparent 20%),
                linear-gradient(45deg, rgba(0, 114, 206, 0.01) 25%, transparent 25%),
                linear-gradient(-45deg, rgba(0, 166, 80, 0.01) 25%, transparent 25%);
            background-size: 300px 300px, 300px 300px, 300px 300px, 20px 20px, 20px 20px;
            opacity: 0.6;
            z-index: -1;
        }
        
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .tech-data-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            opacity: 0.1;
        }
        
        .data-line {
            position: absolute;
            background: linear-gradient(90deg, var(--primary-color), transparent);
            height: 1px;
            width: 100px;
            animation: data-flow 8s infinite linear;
            opacity: 0.4;
        }
        
        .guide-container {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary-color);
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes data-flow {
            0% { transform: translateX(-100px); opacity: 0; }
            10% { opacity: 0.4; }
            90% { opacity: 0.4; }
            100% { transform: translateX(100vw); opacity: 0; }
        }

        .nhri-logo {
            height: 60px;
            margin-right: 10px;
        }

        .logo-placeholder {
            display: flex;
            align-items: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
            background-color: white;
            border-radius: 8px;
            padding: 5px 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .logo-placeholder svg {
            width: 40px;
            height: 40px;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="loading" id="loadingScreen">
        <div class="loading-spinner"></div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <div class="flex flex-col md:flex-row items-center justify-between mb-8">
            <div class="flex items-center mb-4 md:mb-0">
                <div class="logo-placeholder">
                    <svg viewBox="0 0 100 100" xmlns="icon.png">
                        <path d="M50 5C25.2 5 5 25.2 5 50s20.2 45 45 45 45-20.2 45-45S74.8 5 50 5z" fill="#0072CE"/>
                        <path d="M28 30v40h10V55h5v15h10V55h5v15h10V30H28zm10 15V40h5v5h-5zm15 0V40h5v5h-5z" fill="white"/>
                    </svg>
                    <span>國衛院AI管家_問答文字雲生成器</span>
                </div>
            </div>
            <div class="flex flex-wrap gap-2">
                <label class="file-btn flex items-center">
                    <span>選擇Excel檔案</span>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" class="hidden">
                </label>
                <button id="keywordBtn" class="tech-btn">辨識關鍵詞生成文字雲</button>
                <button id="lineBtn" class="tech-btn">辨識整行語意生成文字雲</button>
            </div>
        </div>

        <div class="guide-container">
            <h2 class="text-lg font-bold mb-2">使用指南</h2>
            <ul class="list-disc pl-5">
                <li>預設會嘗試讀取同目錄下的demo.xlsx檔案</li>
                <li>您可以通過「選擇Excel檔案」按鈕上傳自己的檔案</li>
                <li>點擊「辨識關鍵詞生成文字雲」按鈕將根據詞組頻率生成文字雲</li>
                <li>點擊「辨識整行語意生成文字雲」按鈕將以整行文本為單位生成文字雲</li>
            </ul>
        </div>

        <div class="tech-card mb-4 p-0">
            <div class="word-cloud-container">
                <div class="circuit-background"></div>
                <div class="tech-data-lines" id="dataLines"></div>
                <canvas id="wordCloudCanvas"></canvas>
            </div>
        </div>

        <div class="text-center text-gray-500 text-sm mt-8">
            國家衛生研究院智慧醫療文字雲生成器 © 2024
        </div>
    </div>

    <script>
        // 添加動態科技線條元素
        const dataLinesContainer = document.getElementById('dataLines');
        for (let i = 0; i < 10; i++) {
            const line = document.createElement('div');
            line.className = 'data-line';
            line.style.top = `${Math.random() * 100}%`;
            line.style.animationDelay = `${Math.random() * 8}s`;
            dataLinesContainer.appendChild(line);
        }

        // 主要功能變數
        let excelData = [];
        let wordFrequency = {};
        let canvas = document.getElementById('wordCloudCanvas');
        let ctx = canvas.getContext('2d');
        let words = [];
        let animationId;
        
        // 設置Canvas大小
        function resizeCanvas() {
            const container = document.querySelector('.word-cloud-container');
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
        }
        
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // 顯示/隱藏加載動畫
        function showLoading() {
            document.getElementById('loadingScreen').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loadingScreen').style.display = 'none';
        }

        // 讀取Excel檔案
        async function loadExcelFile(file) {
            showLoading();
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        // 過濾空行並只取第一列數據
                        const filteredData = jsonData
                            .filter(row => row.length > 0 && row[0] && typeof row[0] === 'string' && row[0].trim() !== '')
                            .map(row => row[0].trim());
                        
                        resolve(filteredData);
                    } catch (error) {
                        console.error('解析Excel文件時出錯:', error);
                        reject(error);
                    }
                };
                reader.onerror = function(error) {
                    console.error('讀取文件時出錯:', error);
                    reject(error);
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // 嘗試加載默認Excel檔案
        async function loadDefaultExcel() {
            try {
                showLoading();
                const response = await fetch('demo.xlsx');
                if (!response.ok) {
                    throw new Error('無法獲取默認Excel文件');
                }
                const blob = await response.blob();
                excelData = await loadExcelFile(blob);
                console.log('已加載默認Excel文件:', excelData.length, '行');
                hideLoading();
            } catch (error) {
                console.warn('加載默認Excel文件失敗，請手動上傳文件:', error);
                hideLoading();
            }
        }

        // 中文斷詞 - 簡單實現
        function segmentChinese(text) {
            // 這是一個簡化的分詞實現，使用常見的醫療詞彙和基本詞彙
            const medicalTerms = [
                '醫療', '診斷', '治療', '症狀', '疾病', '藥物', '醫師', '護理', '手術', '患者',
                '醫院', '臨床', '研究', '健康', '照護', '預防', '檢測', '檢查', '病理', '病毒',
                '細菌', '感染', '免疫', '抗體', '抗原', '基因', '細胞', '組織', '器官', '系統',
                '血液', '心臟', '肺臟', '肝臟', '腎臟', '脾臟', '胃', '腸', '大腸', '小腸',
                '食道', '膽囊', '胰臟', '腦', '脊髓', '神經', '骨骼', '肌肉', '關節', '韌帶',
                '皮膚', '眼睛', '耳朵', '鼻子', '嘴巴', '喉嚨', '頸部', '胸部', '腹部', '背部',
                '四肢', '血壓', '心率', '呼吸', '體溫', '疼痛', '發燒', '頭痛', '咳嗽', '噁心',
                '嘔吐', '腹瀉', '便秘', '疲勞', '虛弱', '炎症', '腫瘤', '癌症', '糖尿病', '高血壓',
                '心臟病', '腦中風', '肺炎', '肝炎', '腎炎', '關節炎', '過敏', '哮喘', '憂鬱', '焦慮',
                '藥物', '抗生素', '消炎藥', '止痛藥', '退燒藥', '抗組織胺', '疫苗', '維生素', '激素', '抗凝血劑',
                '智慧', '醫療', '人工智能', '機器學習', '大數據', '雲端', '物聯網', '數位化', '遠距', '穿戴式'
            ];
            
            // 將文本中的標點符號替換為空格
            const cleanedText = text.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, ' ');
            
            // 初步按空格分割
            const initialSegments = cleanedText.split(/\s+/).filter(segment => segment.length > 0);
            const result = [];
            
            // 遍歷每個初步分割的片段
            for (const segment of initialSegments) {
                if (segment.length <= 1) {
                    if (segment.length === 1 && /[\u4e00-\u9fa5]/.test(segment)) {
                        result.push(segment);
                    }
                    continue;
                }
                
                // 檢查是否是完整的醫療術語
                if (medicalTerms.includes(segment)) {
                    result.push(segment);
                    continue;
                }
                
                // 嘗試尋找較長的醫療術語
                let found = false;
                for (const term of medicalTerms) {
                    if (segment.includes(term) && term.length > 1) {
                        result.push(term);
                        found = true;
                        // 繼續處理剩餘部分
                        const remaining = segment.replace(term, ' ').trim();
                        if (remaining.length > 0) {
                            // 遞歸處理剩餘部分
                            const subSegments = segmentChinese(remaining);
                            result.push(...subSegments);
                        }
                        break;
                    }
                }
                
                // 如果沒有找到醫療術語，則按字符長度分割
                if (!found) {
                    // 中文按2-3個字符分割
                    if (/^[\u4e00-\u9fa5]+$/.test(segment)) {
                        for (let i = 0; i < segment.length; i += 2) {
                            if (i + 2 <= segment.length) {
                                result.push(segment.substring(i, i + 2));
                            } else if (i < segment.length) {
                                result.push(segment.substring(i));
                            }
                        }
                    } else {
                        // 英文和數字保持原樣
                        result.push(segment);
                    }
                }
            }
            
            // 過濾掉太短的詞
            return result.filter(word => word.length > 0);
        }

        // 計算詞頻
        function calculateWordFrequency(textArray, mode) {
            const frequency = {};
            
            if (mode === 'keyword') {
                // 關鍵詞模式 - 分析每行中的詞組
                textArray.forEach(line => {
                    const segments = segmentChinese(line);
                    segments.forEach(word => {
                        if (word.length <= 1) return; // 忽略單個字符
                        if (frequency[word]) {
                            frequency[word]++;
                        } else {
                            frequency[word] = 1;
                        }
                    });
                });
            } else if (mode === 'line') {
                // 整行語意模式 - 以整行為單位
                textArray.forEach(line => {
                    if (line.length > 50) {
                        // 如果行太長，截斷並添加省略號
                        line = line.substring(0, 47) + '...';
                    }
                    if (frequency[line]) {
                        frequency[line]++;
                    } else {
                        frequency[line] = 1;
                    }
                });
            }
            
            return frequency;
        }

        // 生成彩虹顏色
        function getRandomRainbowColor() {
            const hue = Math.floor(Math.random() * 360);
            const saturation = 70 + Math.random() * 30; // 70-100%
            const lightness = 45 + Math.random() * 10; // 45-55%
            return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
        }

        // 創建文字雲單詞物件
        function createWordObjects(frequency) {
            // 停止之前的動畫
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            
            // 清空現有單詞
            words = [];
            
            // 獲取頻率值
            const entries = Object.entries(frequency);
            if (entries.length === 0) {
                console.warn('沒有足夠的數據生成文字雲');
                return;
            }
            
            // 按頻率排序
            entries.sort((a, b) => b[1] - a[1]);
            
            // 計算最大和最小頻率
            const maxFreq = entries[0][1];
            const minFreq = entries[entries.length - 1][1];
            
            // 確定要顯示的單詞數量 (最多100個)
            const numWords = Math.min(entries.length, 100);
            
            // 創建單詞物件
            for (let i = 0; i < numWords; i++) {
                const [text, freq] = entries[i];
                // 計算字體大小 (12-60px)
                const sizeFactor = (freq - minFreq) / (maxFreq - minFreq || 1);
                const fontSize = 12 + Math.floor(sizeFactor * 48);
                
                // 隨機位置
                const x = Math.random() * (canvas.width - 100) + 50;
                const y = Math.random() * (canvas.height - 100) + 50;
                
                // 隨機速度
                const vx = (Math.random() - 0.5) * 2;
                const vy = (Math.random() - 0.5) * 2;
                
                // 彩虹顏色
                const color = getRandomRainbowColor();
                
                // 添加單詞物件
                words.push({
                    text,
                    fontSize,
                    x,
                    y,
                    vx,
                    vy,
                    color,
                    freq
                });
            }
            
            // 開始動畫
            animateWordCloud();
        }

        // 橢圓碰撞檢測
        function checkEllipseCollision(x, y, width, height) {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radiusX = canvas.width / 2 - width / 2;
            const radiusY = canvas.height / 2 - height / 2;
            
            // 計算點到橢圓中心的距離
            const dx = x - centerX;
            const dy = y - centerY;
            
            // 檢查是否超出橢圓邊界
            return (dx * dx) / (radiusX * radiusX) + (dy * dy) / (radiusY * radiusY) > 1;
        }

        // 動畫文字雲
        function animateWordCloud() {
            // 清除畫布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 繪製每個單詞
            words.forEach(word => {
                // 更新位置
                word.x += word.vx;
                word.y += word.vy;
                
                // 設置字體
                ctx.font = `${word.fontSize}px "Noto Sans TC", sans-serif`;
                ctx.fillStyle = word.color;
                
                // 測量文字寬度
                const textWidth = ctx.measureText(word.text).width;
                const textHeight = word.fontSize * 1.2; // 估計文字高度
                
                // 檢查碰撞
                if (checkEllipseCollision(word.x, word.y, textWidth, textHeight)) {
                    // 計算碰撞反彈
                    const centerX = canvas.width / 2;
                    const centerY = canvas.height / 2;
                    
                    // 計算到中心的向量
                    const dx = word.x - centerX;
                    const dy = word.y - centerY;
                    
                    // 正規化向量
                    const length = Math.sqrt(dx * dx + dy * dy);
                    const nx = dx / length;
                    const ny = dy / length;
                    
                    // 速度反彈 (反向)
                    word.vx = -word.vx + nx * 0.1;
                    word.vy = -word.vy + ny * 0.1;
                    
                    // 調整位置防止卡在邊界
                    word.x += word.vx * 2;
                    word.y += word.vy * 2;
                }
                
                // 繪製文字
                ctx.fillText(word.text, word.x, word.y);
            });
            
            // 繼續動畫
            animationId = requestAnimationFrame(animateWordCloud);
        }

        // 處理文件選擇
        document.getElementById('fileInput').addEventListener('change', async (event) => {
            if (event.target.files.length > 0) {
                try {
                    const file = event.target.files[0];
                    excelData = await loadExcelFile(file);
                    hideLoading();
                    alert(`已成功載入檔案，共 ${excelData.length} 行數據。`);
                } catch (error) {
                    hideLoading();
                    alert('載入檔案失敗：' + error.message);
                }
            }
        });

        // 關鍵詞按鈕點擊事件
        document.getElementById('keywordBtn').addEventListener('click', () => {
            if (excelData.length === 0) {
                alert('請先選擇或等待加載Excel文件！');
                return;
            }
            
            wordFrequency = calculateWordFrequency(excelData, 'keyword');
            createWordObjects(wordFrequency);
        });

        // 整行語意按鈕點擊事件
        document.getElementById('lineBtn').addEventListener('click', () => {
            if (excelData.length === 0) {
                alert('請先選擇或等待加載Excel文件！');
                return;
            }
            
            wordFrequency = calculateWordFrequency(excelData, 'line');
            createWordObjects(wordFrequency);
        });

        // 初始化
        window.addEventListener('load', () => {
            loadDefaultExcel();
        });
    </script>
</body>
</html>
