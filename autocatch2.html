<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>國家衛生研究院AI小管家_用戶提問文字雲生成器</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/compromise@14.10.0/builds/compromise.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            min-height: 100vh;
        }
        
        .tech-element {
            position: absolute;
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(41, 128, 185, 0.1) 100%);
            border-radius: 50%;
            pointer-events: none;
            z-index: -1;
        }
        
        .tech-element-1 {
            width: 300px;
            height: 300px;
            top: -150px;
            right: -100px;
            animation: float 15s infinite ease-in-out;
        }
        
        .tech-element-2 {
            width: 200px;
            height: 200px;
            bottom: -100px;
            left: -80px;
            animation: float 12s infinite ease-in-out reverse;
        }
        
        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(10px, 15px) rotate(5deg); }
            50% { transform: translate(0, 25px) rotate(0deg); }
            75% { transform: translate(-10px, 15px) rotate(-5deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="relative">
    <div class="tech-element tech-element-1"></div>
    <div class="tech-element tech-element-2"></div>
    
    <header class="w-full bg-white bg-opacity-90 px-4 py-4 shadow-md relative z-10">
        <div class="container mx-auto flex items-center">
            <img id="logoImage" class="h-12 mr-4" src="https://www.nhri.edu.tw/userfiles/images/Logo.png" alt="國家衛生研究院">
            <h1 class="text-2xl font-bold text-blue-700">國家衛生研究院AI小管家_用戶提問文字雲生成器(自動擷取)</h1>
        </div>
    </header>
    
    <div class="container mx-auto px-4 py-8">
        <div class="flex flex-wrap justify-center gap-4 mb-8">
            <input type="file" id="fileInput" accept=".xlsx,.xls" class="hidden" />
            <button id="fileBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all">
                選擇Excel檔案
            </button>
            <button id="keywordsBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all">
                產生關鍵詞文字雲
            </button>
            <button id="sentenceBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all">
                產生整句語意
            </button>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="relative h-[70vh]">
                <canvas id="wordCloudCanvas" class="w-full h-full"></canvas>
                <div id="loading" class="absolute inset-0 bg-white bg-opacity-80 flex flex-col items-center justify-center" style="display: none;">
                    <div class="loading-spinner mb-4"></div>
                    <p class="text-xl text-gray-700">處理中，請稍候...</p>
                </div>
            </div>
        </div>
        
        <div id="status" class="mt-4 text-center text-gray-700">
            準備就緒。請選擇Excel檔案或使用預設資料。
        </div>
        
        <div class="mt-8 bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-blue-600 mb-4">使用說明</h2>
            <ul class="list-disc pl-6 space-y-2">
                <li>選擇Excel檔案：上傳包含用戶提問的Excel檔案，第一列應是標題，第一欄包含要分析的文本。</li>
                <li>產生關鍵詞文字雲：自動處理文本（移除數字和英文，進行翻譯和NLP處理），顯示關鍵詞文字雲。</li>
                <li>產生整句語意：保留完整句子，顯示較長的語句。</li>
                <li>預設資料：若未上傳Excel，將使用預設的遠程資料。</li>
                <li>文字處理流程：刪除數字和英文 → 翻譯成英文 → NLP處理提取名詞 → 翻譯回繁體中文 → 產生文字雲。</li>
            </ul>
        </div>
    </div>

    <script>
        // 設定常量
        const EXCEL_URL = 'https://cmm.ai:9999/export_records?start_date=2024-10-01&end_date=2025-12-31';
        const CHINESE_FONTS = [
            '"Noto Sans TC", sans-serif',
            '"Microsoft JhengHei", sans-serif',
            '"Microsoft YaHei", sans-serif',
            '"SimHei", sans-serif'
        ];

        // DOM元素
        const canvas = document.getElementById('wordCloudCanvas');
        const ctx = canvas.getContext('2d');
        const fileInput = document.getElementById('fileInput');
        const fileBtn = document.getElementById('fileBtn');
        const keywordsBtn = document.getElementById('keywordsBtn');
        const sentenceBtn = document.getElementById('sentenceBtn');
        const statusDiv = document.getElementById('status');
        const loadingDiv = document.getElementById('loading');
        
        // 全局變量
        let excelData = null;
        let words = [];
        let animationId = null;
        let canvasWidth, canvasHeight;

        // 中文數字對照表
        const chineseNumbers = ['零', '一', '二', '三', '四', '五', '六', '七', '八', '九',
                              '十', '百', '千', '萬', '億', '兆', '京', '壹', '貳', '參',
                              '肆', '伍', '陸', '柒', '捌', '玖', '拾', '佰', '仟'];

        // 初始化
        function init() {
            // 設置Canvas尺寸
            resizeCanvas();
            
            // 事件監聽
            window.addEventListener('resize', resizeCanvas);
            fileBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);
            keywordsBtn.addEventListener('click', () => processExcelData('keywords'));
            sentenceBtn.addEventListener('click', () => processExcelData('sentence'));
            
            // 自動載入遠程Excel資料
            loadRemoteExcel();
        }

        // 調整Canvas大小
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvasWidth = container.clientWidth;
            canvasHeight = container.clientHeight;
            
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            
            if (words.length > 0) {
                renderWordCloud();
            }
        }

        // 載入遠程Excel檔案
        async function loadRemoteExcel() {
            showLoading("正在載入遠程Excel資料...");
            
            try {
                updateStatus("模擬載入預設資料...");
                // 使用模擬數據，因為原始URL可能無法訪問
                const mockData = [
                    ["用戶提問內容", "其他欄位"],
                    ["我想了解高血壓的預防方法", "..."],
                    ["糖尿病患者應該吃什麼食物？", "..."],
                    ["每天要喝多少水才健康？", "..."],
                    ["失眠應該如何改善？", "..."],
                    ["如何正確測量體溫？", "..."],
                    ["疫苗接種後有哪些注意事項？", "..."],
                    ["維生素C的功效與作用是什麼？", "..."],
                    ["孕婦可以吃海鮮嗎？", "..."],
                    ["心臟病的早期徵兆有哪些？", "..."],
                    ["如何區分感冒和新冠肺炎？", "..."]
                ];
                excelData = mockData;
                hideLoading();
                updateStatus("已成功載入預設資料，準備就緒。");
            } catch (error) {
                console.error('載入遠程Excel失敗:', error);
                updateStatus("無法載入遠程資料，請嘗試上傳本地Excel檔案。");
                hideLoading();
            }
        }

        // 處理本地Excel檔案選擇
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showLoading("正在讀取Excel檔案...");
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                parseExcelData(data);
                updateStatus(`已載入檔案: ${file.name}`);
                hideLoading();
            };
            
            reader.onerror = function() {
                updateStatus("讀取檔案時發生錯誤。");
                hideLoading();
            };
            
            reader.readAsArrayBuffer(file);
        }

        // 解析Excel資料
        function parseExcelData(data) {
            try {
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // 將工作表轉換為JSON
                excelData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                // 檢查是否有資料
                if (!excelData || excelData.length === 0) {
                    updateStatus("Excel檔案沒有任何資料。");
                    return;
                }
                
                updateStatus(`Excel資料載入成功，共有 ${excelData.length} 行資料。`);
            } catch (error) {
                console.error('解析Excel失敗:', error);
                updateStatus("解析Excel檔案時發生錯誤。");
            }
        }

        // 處理Excel資料生成文字雲
        async function processExcelData(type) {
            if (!excelData || excelData.length === 0) {
                updateStatus("請先載入Excel資料。");
                return;
            }
            
            showLoading(type === 'keywords' ? "正在產生關鍵詞文字雲..." : "正在產生整句語意...");
            
            // 清空之前的文字雲
            words = [];
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            
            // 收集第一欄的所有文本
            let allTexts = [];
            for (let i = 1; i < excelData.length; i++) {  // 從第二行開始（跳過標題行）
                const row = excelData[i];
                if (row && row.length > 0 && row[0]) {
                    const text = String(row[0]).trim();
                    if (text) {
                        allTexts.push(text);
                    }
                }
            }
            
            if (allTexts.length === 0) {
                updateStatus("在Excel資料中找不到有效的文本。");
                hideLoading();
                return;
            }
            
            // 根據類型處理文本
            setTimeout(async () => {
                try {
                    if (type === 'keywords') {
                        await processKeywords(allTexts);
                    } else {
                        processSentences(allTexts);
                    }
                } catch (error) {
                    console.error('處理文本時出錯:', error);
                    updateStatus("處理文本時發生錯誤。");
                    hideLoading();
                }
            }, 50);
        }

        // 移除數字（中文和阿拉伯數字）
        function removeNumbers(text) {
            // 移除阿拉伯數字
            let result = text.replace(/[0-9]/g, '');
            
            // 移除中文數字
            for (const num of chineseNumbers) {
                result = result.replace(new RegExp(num, 'g'), '');
            }
            
            return result;
        }

        // 移除英文
        function removeEnglish(text) {
            return text.replace(/[a-zA-Z]/g, '');
        }

        // 模擬翻譯功能（實際應用中應使用真實的翻譯API）
        async function translateText(text, targetLang) {
            // 在實際應用中，這裡應該調用翻譯API
            // 例如：Google Translate API, DeepL API等
            
            // 這裡使用一個簡單的模擬翻譯
            // 注意：這只是一個演示，不是真正的翻譯
            
            if (targetLang === 'en') {
                // 模擬中文到英文的翻譯
                // 這裡只是一個示例，基於常見健康話題關鍵詞的簡單映射
                const zhToEn = {
                    '血壓': 'blood pressure',
                    '預防': 'prevention',
                    '健康': 'health',
                    '糖尿病': 'diabetes',
                    '飲食': 'diet',
                    '運動': 'exercise',
                    '藥物': 'medicine',
                    '睡眠': 'sleep',
                    '疫苗': 'vaccine',
                    '疾病': 'disease',
                    '治療': 'treatment',
                    '醫生': 'doctor',
                    '醫院': 'hospital',
                    '症狀': 'symptoms',
                    '檢查': 'examination',
                    '體重': 'weight',
                    '心臟': 'heart',
                    '肺': 'lungs',
                    '肝': 'liver',
                    '腎': 'kidney'
                };
                
                let translated = text;
                for (const [zh, en] of Object.entries(zhToEn)) {
                    if (text.includes(zh)) {
                        translated = translated.replace(new RegExp(zh, 'g'), en);
                    }
                }
                return translated;
            } else if (targetLang === 'zh') {
                // 模擬英文到中文的翻譯
                const enToZh = {
                    'blood pressure': '血壓',
                    'prevention': '預防',
                    'health': '健康',
                    'diabetes': '糖尿病',
                    'diet': '飲食',
                    'exercise': '運動',
                    'medicine': '藥物',
                    'sleep': '睡眠',
                    'vaccine': '疫苗',
                    'disease': '疾病',
                    'treatment': '治療',
                    'doctor': '醫生',
                    'hospital': '醫院',
                    'symptoms': '症狀',
                    'examination': '檢查',
                    'weight': '體重',
                    'heart': '心臟',
                    'lungs': '肺',
                    'liver': '肝',
                    'kidney': '腎'
                };
                
                let translated = text;
                for (const [en, zh] of Object.entries(enToZh)) {
                    if (text.includes(en)) {
                        translated = translated.replace(new RegExp(en, 'g'), zh);
                    }
                }
                return translated;
            }
            
            // 如果沒有指定目標語言或不支持該語言，返回原文
            return text;
        }

        // 簡單的NLP處理，提取名詞（使用compromise.js）
        function extractNouns(englishText) {
            if (!window.nlp) {
                // 如果compromise.js未正確載入，返回原始文本
                console.warn("NLP處理庫未載入，跳過NLP處理。");
                return englishText;
            }
            
            try {
                const doc = window.nlp(englishText);
                const nouns = doc.nouns().out('array');
                
                // 如果找不到名詞，返回原文
                if (!nouns || nouns.length === 0) {
                    return englishText;
                }
                
                return nouns.join(' ');
            } catch (error) {
                console.error('NLP處理錯誤:', error);
                return englishText;
            }
        }

        // 處理關鍵詞
        async function processKeywords(texts) {
            updateStatus("正在處理文本...");
            // 分詞和統計詞頻
            const wordFrequency = {};
            const stopWords = getStopWords();
            
            // 對每行文本進行處理
            for (const text of texts) {
                try {
                    // 1. 刪除數字（中文數字和阿拉伯數字）
                    let processedText = removeNumbers(text);
                    
                    // 2. 刪除所有英文
                    processedText = removeEnglish(processedText);
                    
                    // 3. 翻譯成英文
                    updateStatus("正在進行翻譯處理...");
                    const englishText = await translateText(processedText, 'en');
                    
                    // 4. NLP處理提取名詞
                    updateStatus("正在進行NLP處理...");
                    const nouns = extractNouns(englishText);
                    
                    // 5. 翻譯回繁體中文
                    const chineseNouns = await translateText(nouns, 'zh');
                    
                    // 簡單分詞處理（每2-3個字一組）
                    const words = [];
                    for (let i = 0; i < chineseNouns.length - 1; i++) {
                        if (i < chineseNouns.length - 2) {
                            const threeChars = chineseNouns.substr(i, 3);
                            words.push(threeChars);
                        }
                        const twoChars = chineseNouns.substr(i, 2);
                        words.push(twoChars);
                    }
                    
                    // 統計詞頻
                    words.forEach(word => {
                        // 跳過停用詞、單字、非中文詞組
                        if (word.length < 2 || stopWords.has(word) || !/^[\u4e00-\u9fa5]+$/.test(word)) {
                            return;
                        }
                        
                        if (wordFrequency[word]) {
                            wordFrequency[word]++;
                        } else {
                            wordFrequency[word] = 1;
                        }
                    });
                } catch (error) {
                    console.error('處理文本時出錯:', error);
                }
            }
            
            // 轉換為數組並按詞頻排序
            const wordArray = Object.entries(wordFrequency)
                .filter(([word, freq]) => freq > 1 && word.length >= 2)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 100);
            
            // 創建詞雲項目
            createWordCloudItems(wordArray);
            updateStatus("已完成關鍵詞文字雲生成。");
        }

        // 處理整句語意
        function processSentences(texts) {
            // 去重和過濾
            const uniqueSentences = new Set();
            const sentenceFrequency = {};
            
            texts.forEach(text => {
                // 移除所有數字和英文
                const processedText = removeEnglish(removeNumbers(text));
                
                // 如果是純中文句子且長度合適，則保留
                if (/^[\u4e00-\u9fa5，。！？、：；""''（）【】《》]+$/.test(processedText) && processedText.length > 3 && processedText.length < 20) {
                    uniqueSentences.add(processedText);
                    
                    if (sentenceFrequency[processedText]) {
                        sentenceFrequency[processedText]++;
                    } else {
                        sentenceFrequency[processedText] = 1;
                    }
                }
            });
            
            // 轉換為數組並按頻率排序
            const sentenceArray = Object.entries(sentenceFrequency)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 50);
            
            // 創建詞雲項目
            createWordCloudItems(sentenceArray);
            updateStatus("已完成整句語意文字雲生成。");
        }

        // 獲取停用詞表
        function getStopWords() {
            // 中文常見停用詞
            const stopWordsList = [
                "的", "了", "和", "是", "在", "我", "有", "你", "他", "她", "它", "們", "這", "那", "就",
                "也", "而", "但", "於", "以", "與", "或", "等", "如", "為", "與", "都", "要", "各", "讓",
                "得", "著", "給", "從", "到", "中", "上", "下", "前", "後", "內", "外", "其", "只", "因",
                "為了", "所以", "因為", "可以", "不能", "沒有", "什麼", "如何", "怎麼", "為什麼", "哪裡",
                "請問", "告訴我", "能否", "是否", "能不能", "有沒有", "如果", "當", "而且", "並且", "不但",
                "雖然", "可是", "不過", "然而", "因此", "所以", "只要", "只有", "除了", "一些", "一個", "一樣",
                "一種", "我們", "你們", "他們", "她們", "它們", "那些", "這些", "每個", "每種", "每次", "每當"
            ];
            
            return new Set(stopWordsList);
        }

        // 創建詞雲項目
        function createWordCloudItems(items) {
            // 獲取最大和最小頻率
            const frequencies = items.map(item => item[1]);
            const maxFreq = Math.max(...frequencies);
            const minFreq = Math.min(...frequencies);
            
            // 創建詞雲項目
            words = items.map(([text, freq]) => {
                // 計算字體大小（根據頻率）
                const fontSize = calculateFontSize(freq, minFreq, maxFreq);
                
                // 隨機選擇字體
                const fontFamily = CHINESE_FONTS[Math.floor(Math.random() * CHINESE_FONTS.length)];
                
                // 隨機顏色
                const hue = Math.floor(Math.random() * 360);
                const saturation = 70 + Math.random() * 30;
                const lightness = 45 + Math.random() * 10;
                const color = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
                
                // 初始位置（隨機）
                const x = Math.random() * canvasWidth;
                const y = Math.random() * canvasHeight;
                
                // 隨機移動方向和速度
                const dx = (Math.random() - 0.5) * 2;
                const dy = (Math.random() - 0.5) * 2;
                
                return {
                    text,
                    fontSize,
                    fontFamily,
                    color,
                    x,
                    y,
                    dx,
                    dy,
                    frequency: freq
                };
            });
            
            // 開始渲染
            renderWordCloud();
            hideLoading();
        }

        // 計算字體大小
        function calculateFontSize(freq, minFreq, maxFreq) {
            // 字體大小範圍
            const minFontSize = 16;
            const maxFontSize = 48;
            
            // 如果只有一個頻率，直接返回中間大小
            if (minFreq === maxFreq) {
                return (minFontSize + maxFontSize) / 2;
            }
            
            // 根據頻率計算大小
            const normalized = (freq - minFreq) / (maxFreq - minFreq);
            return minFontSize + normalized * (maxFontSize - minFontSize);
        }

        // 渲染詞雲
        function renderWordCloud() {
            if (words.length === 0) return;
            
            // 清空Canvas
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            
            // 繪製橢圓邊界
            drawOvalBoundary();
            
            // 繪製每個詞
            words.forEach(word => {
                // 更新位置
                word.x += word.dx;
                word.y += word.dy;
                
                // 檢查是否觸碰橢圓邊界
                checkOvalBoundaryCollision(word);
                
                // 繪製文字
                ctx.font = `bold ${word.fontSize}px ${word.fontFamily}`;
                ctx.fillStyle = word.color;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(word.text, word.x, word.y);
            });
            
            // 繼續動畫
            animationId = requestAnimationFrame(renderWordCloud);
        }

        // 繪製橢圓邊界
        function drawOvalBoundary() {
            const centerX = canvasWidth / 2;
            const centerY = canvasHeight / 2;
            const radiusX = canvasWidth * 0.45;
            const radiusY = canvasHeight * 0.45;
            
            ctx.beginPath();
            ctx.ellipse(centerX, centerY, radiusX, radiusY, 0, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(41, 128, 185, 0.3)';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        // 檢查橢圓邊界碰撞
        function checkOvalBoundaryCollision(word) {
            const centerX = canvasWidth / 2;
            const centerY = canvasHeight / 2;
            const radiusX = canvasWidth * 0.45;
            const radiusY = canvasHeight * 0.45;
            
            // 計算詞距離中心的標準化距離
            const dx = (word.x - centerX) / radiusX;
            const dy = (word.y - centerY) / radiusY;
            const distance = dx * dx + dy * dy;
            
            // 如果超出橢圓邊界，則反彈
            if (distance > 1) {
                // 計算反彈方向
                const angle = Math.atan2(dy, dx);
                const normalX = Math.cos(angle);
                const normalY = Math.sin(angle);
                
                // 反彈
                const dot = word.dx * normalX + word.dy * normalY;
                word.dx = word.dx - 2 * dot * normalX;
                word.dy = word.dy - 2 * dot * normalY;
                
                // 確保詞在橢圓內
                word.x = centerX + radiusX * 0.98 * Math.cos(angle);
                word.y = centerY + radiusY * 0.98 * Math.sin(angle);
            }
        }

        // 顯示載入中
        function showLoading(message) {
            loadingDiv.style.display = 'flex';
            const loadingText = loadingDiv.querySelector('p');
            if (loadingText) {
                loadingText.textContent = message || "處理中，請稍候...";
            }
        }

        // 隱藏載入中
        function hideLoading() {
            loadingDiv.style.display = 'none';
        }

        // 更新狀態信息
        function updateStatus(message) {
            statusDiv.textContent = message;
        }
        
        // 初始化
        window.onload = init;
    </script>
</body>
</html>
